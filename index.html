<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Ansible Tutorial</title>
    <style type="text/css">
pre code {
  font-family: courier new;
  font-size: 9pt;
}
span.console-yellow {
  color: #FCE94F;
}
span.console-green {
  color: #8AE234;
}
span.console-blue {
  color: #3465A4;
}
span.console-red {
  color: #EF2929;
}
span.console-input {
  font-weight: bold;
  font-size: 10pt;
}
dd {
  margin-left: 2em;
  margin-bottom: 0.5em;
}
li ol {
  margin-left: 1em;
  margin-bottom: 0;
}
blockquote {
  font-size: 10pt;
}
    </style>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721713-1', 'yteraoka.github.io');
  ga('send', 'pageview');

</script>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Ansible Tutorial</h1>
          <h2>あんしぼー ちゅーとりある</h2>
        </header>

<!--
        <section id="downloads" class="clearfix">
          <a href="https://github.com/yteraoka/test/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/yteraoka/test/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/yteraoka/test" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>
-->

        <hr>

        <section id="main_content">

          <h3><a name="overview" class="anchor" href="#overview"><span class="octicon octicon-link"></span></a>概要</h3>

<p><a href="http://www.techfesta.jp/">July Tech Festa</a> にて開催されたハンズオンの<a href="http://tily.github.io/jtf2013/">資料が公開</a>されていたことに刺激され、Chef の代わりに Ansible を使う資料を作り<del>ました</del>始めました。
Ansible を使って WordPress サーバーのセットアップを行います。<br>
まだ Ansible を試し始めたばかりで自分の勉強がてら書いています。<br>
Puppet にも Chef にも乗り遅れたので Ansible に飛び乗ってみようかと。
</p>
<p>
※鋭意作成中です。<br>
そのため Github にある playbook を実行した結果と必ずしも同じでは無いことがあります。<br>
<a href="https://github.com/yteraoka/ansible-tutorial/">https://github.com/yteraoka/ansible-tutorial/</a> コメントなどお待ちしております。<a href="https://twitter.com/yteraoka">@yteraoka</a><br>
<br>
少しずつ更新してます、また来てね。
</p>


<h3><a name="about-ansible" class="anchor" href="#about-ansible"><span class="octicon octicon-link"></span></a>Ansible とは</h3>
<p>
Ansible のサイト (<a href="http://www.ansibleworks.com/">AnsibleWorks | Radically simple IT orchestration</a>) には次のように書いてあります。
<blockquote>
Ansible は非常にシンプルなIT構成エンジンです。これはあなたのアプリケーションやシステムのデプロイを容易にします。スクリプトや専用のコードを書くことなくアプリケーションをデプロイし、更新することができます。エージェントをインストールすることなく、SSH を使い、自然な英語に近い感覚で自動化します。<br>
Ansible は最もシンプルな構成管理、自動化ツールです。
</blockquote>
以下のサイトも参考になります
<ul>
  <li><a href="http://apatheia.info/blog/2013/04/06/about-ansible/">構成管理ツール Ansible について - apatheia.info</a></li>
  <li><a href="http://tdoc.info/blog/2013/04/20/ansible.html">ansibleを使ってみる &mdash; そこはかとなく書くよん。</a></li>
  <li><a href="https://speakerdeck.com/yeukhon/deploying-with-vagrant-and-ansible">Deploying with Vagrant and Ansible by yeukhon</a> [speakerdeck]<br>(これ、とても良いスライドです。この Tutorial の後にどうぞ..)</li>
</ul>
</p>

<h3><a name="table-of-contents" class="anchor" href="#table-of-contents"><span class="octicon octicon-link"></span></a>目次</h3>

<p>
<ol>
  <li><a href="#server-setup-using-vagrant">Vagrant を使ってサーバーを準備する</a></li>
  <li><a href="#install-ansible">Ansible のインストール</a></li>
  <li><a href="#prepare-ansible">Ansible を使うための準備</a></li>
  <li><a href="#test-ansible">Ansible の疎通確認</a></li>
  <li><a href="#simple-playbook">簡単な Playbook を書いて試す</a></li>
  <li><a href="#gather-facts">対象ホストの情報を取得 (GATHERING FACTS)</a></li>
  <li><a href="#best-practices">Best Plactices に沿った構成を真似る</a>
    <ol>
      <li><a href="#best-practices-directory">各ディレクトリ、ファイルの役割・意味</a>
      <li><a href="#list-variable">リスト型変数を使った処理</a>
      <li><a href="#mysql">MySQL 関連</a>
    </ol>
  </li>
  <li><a href="#test-with-serverspec">serverspec でテストする</a>
    <ol>
      <li><a href="#install-ruby">Ruby のインストール</a>
      <li><a href="#install-serverspec">ServerSpec のインストール</a>
      <li><a href="#execute-serverspec">ServerSpec を実行してみる</a>
      <li><a href="#test-mysqld">mysqld のテストを作成</a>
      <li><a href="#test-wordpress">WordPress のテストを作成</a>
    </ol>
  </li>
  <li><a href="ansible-in-detail.html">もっと知る</a></li>
</ol>
</p>

<h3><a name="server-setup-using-vagrant" class="anchor" href="#server-setup-using-vagrant"><span class="octicon octicon-link"></span></a>1. Vagrant を使ってサーバーを準備する</h3>
<p>
何度でも綺麗な環境でやり直せるように VirtualBox + Vagrant を使ってこの Tutorial 用環境を構築します。

<ul>
  <li><a href="http://blog.1q77.com/2013/03/vagrant-1/">Vagrant メモ(1)</a></li>
  <li><a href="http://blog.1q77.com/2013/03/vagrant-2/">Vagrant メモ(2)</a></li>
</ul>

あたりを参考に最新版の VirtualBox と Vagrant をインストールしてください。
Sahara plugin なんかを使うとやり直しも簡単ですが、再構築してもそんなに時間かからないのでお好みで。

<pre><code>$ <span class="console-input">mkdir ansible-tutorial</span>
$ <span class="console-input">cd ansible-tutorial</span>
$ <span class="console-input">vagrant init centos6 http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20130427.box</span>
</code></pre>

Ansible サーバーと、Ansible に制御される側の2台のサーバーを立てることにするので <code>Vagrantfile</code> を編集します。

<pre><code>$ <span class="console-input">vi Vagrantfile</span></code></pre>

<code>config.vm.box = "centos6"</code> の行を次のように書き換えます。2台じゃなくて3台でも4台でもOK

<pre>
  config.vm.define :node1 do |node|
    node.vm.box = "centos6"
    node.vm.network :forwarded_port, guest: 22, host: 2001, id: "ssh"
    node.vm.network :private_network, ip: "192.168.33.11"
  end

  config.vm.define :node2 do |node|
    node.vm.box = "centos6"
    node.vm.network :forwarded_port, guest: 22, host: 2002, id: "ssh"
    node.vm.network :forwarded_port, guest: 80, host: 8000, id: "http"
    node.vm.network :private_network, ip: "192.168.33.12"
  end
</pre>

編集が終わったら起動させます。
<pre><code>$ <span class="console-input">vagrant up</span></code></pre>

起動後、Ansible で node1 から node2 へ ssh するため、Vagrant 用の秘密鍵をコピーする。
<pre><code>$ <span class="console-input">vagrant ssh-config node1 &gt; ssh_config</span>
$ <span class="console-input">vagrant ssh-config node2 &gt;&gt; ssh_config</span>
$ <span class="console-input">scp -F ssh_config ~/.vagrant.d/insecure_private_key node1:.ssh/id_rsa</span>
</code></pre>

<code>vagrant ssh</code> コマンドでログインできます
<pre><code>$ <span class="console-input">vagrant ssh node1</span>
$ <span class="console-input">vagrant ssh node2</span>
</code></pre>

やり直したくなったら destroy して up すれば元の状態に戻ります
<pre><code>$ <span class="console-input">vagrant destroy node2</span>
$ <span class="console-input">vagrant up node2</span>
</code></pre>
</p>

<h3><a name="install-ansible" class="anchor" href="#install-ansible"><span class="octicon octicon-link"></span></a>2. Ansible をインストールする</h3>

<p>
node1 に Ansible をインストールします。CentOS 6 なので EPEL リポジトリから yum でインストールします。

<pre><code>$ <span class="console-input">sudo rpm -ivh http://ftp-srv2.kddilabs.jp/Linux/distributions/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
$ <span class="console-input">sudo rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</span>
$ <span class="console-input">sudo yum -y install ansible</span>
</code></pre>

楽ちんですね。

</p>


<h3>
<a name="prepare-ansible" class="anchor" href="#prepare-ansible"><span class="octicon octicon-link"></span></a>3. Ansible を使うための準備</h3>

<p>
vagrant ssh を使うと vagrant ユーザーでログインし、パスワードなしで sudo で root としてコマンドが実行可能なので、Ansible の実行も vagrant ユーザーで行う。
</p>

<h3>
<a name="test-ansible" class="anchor" href="#test-ansible"><span class="octicon octicon-link"></span></a>4. Ansible の疎通確認</h3>

<p>
<pre><code>$ <span class="console-input">ansible 192.168.33.12 -m ping</span>
<span class="console-green">192.168.33.12 | success &gt;&gt; {
    "changed": false, 
    "ping": "pong"
}</span></code></pre>

<code>ansible-doc</code> コマンドでモジュールのドキュメントを読むことができます。
<pre><code>$ <span class="console-input">ansible-doc ping</span>
&gt; PING

  A trivial test module, this module always returns `pong' on
  successful contact. It does not make sense in playbooks, but it is
  useful from `/usr/bin/ansible'

Example:

ansible webservers -m ping
</code></pre>

<pre><code>$ <span class="console-input">ansible 192.168.33.12 -a 'uname -r'</span>
<span class="console-green">192.168.33.12 | success | rc=0 &gt;&gt;
2.6.32-358.el6.x86_64</span></code></pre>
</p>

<h3>
<a name="simple-playbook" class="anchor" href="#simple-playbook"><span class="octicon octicon-link"></span></a>5. 簡単な Playbook を書いて試す</h3>

<p>
まずは<a href="ansible-in-detail.html#inventory-file">インベントリファイル</a>を作成する。yum でインストールした Ansible の場合、デフォルトのインベントリファイルは <code>/etc/ansible/hosts</code> となっている。これは <code>/etc/ansible/ansible.cfg</code> で定義されている。別のファイルを使う場合は <code>-i</code> オプションで指定する。
<pre><code>$ <span class="console-input">cat &lt;&lt;_EOD_ &gt; hosts</span>
[test-servers]
192.168.33.12
<span class="console-input">_EOD_</span>
</code></pre>
<pre><code>$ <span class="console-input">cat &lt;&lt;_EOD_ &gt; simple-playbook.yml</span>
- hosts: test-servers
  user: vagrant
  sudo: yes
  tasks:
    - name: be sure httpd is installed
      action: yum pkg=httpd state=installed

    - name: be sure httpd is running and enabled
      service: name=httpd state=running enabled=yes
<span class="console-input">_EOD_</span>
</code></pre>

この playbook の内容は
<dl>
  <dt><code>hosts: test</code></dt>
  <dd>対象のホストまたはグループを指定する</dd>
  <dt><code>user: vagrant</code></dt>
  <dd>リモートホストへ vagrant ユーザとして ssh でログインする</dd>
  <dt><code>sudo: yes</code></dt>
  <dd>リモートホストで sudo を使って処理を実行する</dd>
  <dt><code>tasks:</code></dt>
  <dd>実行する処理をリストで定義する</dd>
</dl>

<code>tasks</code> の内容
<dl>
  <dt><code>name:</code></dt>
  <dd>処理の名称。実行時や task の一覧で表示されます</dd>
  <dt><code>action:</code></dt>
  <dd>これは省略可能で <code>yum:</code> とも書ける</dd>
  <dt><code>service:</code></dt>
  <dd>サービスの状態を制御するモジュール</dd>
</dl>

playbook の syntax チェックを行なってみます。<code>--syntax-check</code> オプションを使います。
<pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml --syntax-check</span>
Playbook Syntax is fine
</code></pre>

次に task の一覧を確認してみましょう。<code>--list-tasks</code> オプションを使います。(<a href="ansible-in-detail.html#ansible-playbook">その他のオプション一覧はこちら</a>)。
<pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml --list-tasks</span>

playbook: simple-playbook.yml

  play #1 (test-servers): task count=5
    be sure httpd is installed
    be sure httpd is running and enabled

</code></pre>

次は dry-run です、<code>--check</code> オプションを指定することで変更は行わないが、実際に実行するとこうなるという出力がされます。
<pre><code>$ ansible-playbook -i hosts simple-playbook.yml --check

PLAY [test-servers] *********************************************************** 

GATHERING FACTS *************************************************************** 
<span class="console-green">ok: [192.168.33.12]</span>

TASK: [be sure httpd is installed] ******************************************** 
<span class="console-yellow">changed: [192.168.33.12]</span>

TASK: [be sure httpd is running and enabled] ********************************** 
<span class="console-red">failed: [192.168.33.12] =&gt; {"failed": true}
msg: cannot find 'service' binary or init script for service,  possible typo in service name?, aborting

FATAL: all hosts have already failed -- aborting</span>

PLAY RECAP ******************************************************************** 
           to retry, use: --limit @/var/tmp/ansible/simple-playbook.retry

<span class="console-red">192.168.33.12</span>              : <span class="console-green">ok=2</span>    <span class="console-yellow">changed=1</span>    unreachable=0    <span class="console-red">failed=1</span>

</code></pre>
あららら？なんか failed って出てますね。まぁ、順番に見てみましょう。一つ目のインストールする task は changed となっています。これは、まだ httpd がインストールされていないので、実際に実行するとインストールされて changed となるということを意味しています。次の自動起動と起動している状態にする task は失敗してしまっています。これはまだ httpd がインストールされていないために、<code>chkconfig httpd</code> などに失敗するからです。<br>
<br>
ではいよいよ実行してみましょう。

<pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml</span>

PLAY [test-servers] *********************************************************** 

GATHERING FACTS *************************************************************** 
<span class="console-green">ok: [192.168.33.12]</span>

TASK: [be sure httpd is installed] ******************************************** 
<span class="console-yellow">changed: [192.168.33.12]</span>

TASK: [be sure httpd is running and enabled] ********************************** 
<span class="console-yellow">changed: [192.168.33.12]</span>

PLAY RECAP ******************************************************************** 
<span class="console-yellow">192.168.33.12</span>              : <span class="console-green">ok=3</span>    <span class="console-yellow">changed=2</span>    unreachable=0    failed=0
</code></pre>
うまくいきましたね。<br>
<br>
node2 で確認
<pre><code>$ <span class="console-input">sudo chkconfig --list httpd</span>
httpd          	0:off	1:off	2:on	3:on	4:on	5:on	6:off
$ <span class="console-input">sudo service httpd status</span>
httpd (pid  2424) is running...
</code></pre>

冪等性があるため再度実行しても対象サーバーの状態は変わらない。
ただし、既に package がインストールされていたり、サービスの設定がされていたりするのでコマンドの出力は変わる。(changed が ok だったり skipping だったりする)
<br>
<br>
2度目の実行の出力
<pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml</span>

PLAY [test-servers] *********************************************************** 

GATHERING FACTS *************************************************************** 
<span class="console-green">ok: [192.168.33.12]</span>

TASK: [be sure httpd is installed] ******************************************** 
<span class="console-green">ok: [192.168.33.12]</span>

TASK: [be sure httpd is running and enabled] ********************************** 
<span class="console-green">ok: [192.168.33.12]</span>

PLAY RECAP ******************************************************************** 
<span class="console-green">192.168.33.12</span>              : <span class="console-green">ok=3</span>    changed=0    unreachable=0    failed=0
</code></pre>
</p>


<h3>
<a name="gather-facts" class="anchor" href="#gather-facts"><span class="octicon octicon-link"></span></a>6. 対象ホストの情報を取得する</h3>
<p>
実行結果に「GATHERING FACTS」と出力されています。このような task は playbook に書いていません。これは何でしょう？結構時間かかってます(非力な virtual server だから?)。<br>
名前のとおりですが、これは対象サーバーから情報を収集する処理です。次のようにして内容を確認すことができます。
<pre style="height: 300px;"><code>$ <span class="console-input">ansible -m setup -i hosts 192.168.33.12</span>
192.168.33.12 | success &gt;&gt; {
    "ansible_facts": {
        "ansible_all_ipv4_addresses": [
            "10.0.2.15", 
            "192.168.33.12"
        ], 
        "ansible_all_ipv6_addresses": [
            "fe80::a00:27ff:fec9:399e", 
            "fe80::a00:27ff:fed5:dab6"
        ], 
        "ansible_architecture": "x86_64", 
        "ansible_bios_date": "12/01/2006", 
        "ansible_bios_version": "VirtualBox", 
        "ansible_cmdline": {
            "KEYBOARDTYPE": "pc", 
            "KEYTABLE": "us", 
            "LANG": "en_US.UTF-8", 
            "SYSFONT": "latarcyrheb-sun16", 
            "quiet": true, 
            "rd_LVM_LV": "VolGroup/lv_root", 
            "rd_NO_DM": true, 
            "rd_NO_LUKS": true, 
            "rd_NO_MD": true, 
            "rhgb": true, 
            "ro": true, 
            "root": "/dev/mapper/VolGroup-lv_root"
        }, 
        "ansible_date_time": {
            "date": "2013-08-08", 
            "day": "08", 
            "epoch": "1375968652", 
            "hour": "13", 
            "iso8601": "2013-08-08T13:30:52Z", 
            "iso8601_micro": "2013-08-08T13:30:52.873665Z", 
            "minute": "30", 
            "month": "08", 
            "second": "52", 
            "time": "13:30:52", 
            "tz": "UTC", 
            "year": "2013"
        }, 
        "ansible_default_ipv4": {
            "address": "10.0.2.15", 
            "alias": "eth0", 
            "gateway": "10.0.2.2", 
            "interface": "eth0", 
            "macaddress": "08:00:27:c9:39:9e", 
            "mtu": 1500, 
            "netmask": "255.255.255.0", 
            "network": "10.0.2.0", 
            "type": "ether"
        }, 
        "ansible_default_ipv6": {}, 
        "ansible_devices": {
            "sda": {
                "holders": [], 
                "host": "SATA controller: Intel Corporation 82801HM/HEM (ICH8M/ICH8M-E) SATA Controller [AHCI mode] (rev 02)", 
                "model": "VBOX HARDDISK", 
                "partitions": {
                    "sda1": {
                        "sectors": "1024000", 
                        "sectorsize": 512, 
                        "size": "500.00 MB", 
                        "start": "2048"
                    }, 
                    "sda2": {
                        "sectors": "1047549952", 
                        "sectorsize": 512, 
                        "size": "499.51 GB", 
                        "start": "1026048"
                    }
                }, 
                "removable": "0", 
                "rotational": "1", 
                "scheduler_mode": "cfq", 
                "sectors": "1048576000", 
                "sectorsize": "512", 
                "size": "500.00 GB", 
                "support_discard": "0", 
                "vendor": "ATA"
            }, 
            "sr0": {
                "holders": [], 
                "host": "IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)", 
                "model": "CD-ROM", 
                "partitions": {}, 
                "removable": "1", 
                "rotational": "1", 
                "scheduler_mode": "cfq", 
                "sectors": "2097151", 
                "sectorsize": "512", 
                "size": "1024.00 MB", 
                "support_discard": "0", 
                "vendor": "VBOX"
            }, 
            "sr1": {
                "holders": [], 
                "host": "IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)", 
                "model": "CD-ROM", 
                "partitions": {}, 
                "removable": "1", 
                "rotational": "1", 
                "scheduler_mode": "cfq", 
                "sectors": "2097151", 
                "sectorsize": "512", 
                "size": "1024.00 MB", 
                "support_discard": "0", 
                "vendor": "VBOX"
            }
        }, 
        "ansible_distribution": "CentOS", 
        "ansible_distribution_release": "Final", 
        "ansible_distribution_version": "6.4", 
        "ansible_domain": "localdomain", 
        "ansible_eth0": {
            "active": true, 
            "device": "eth0", 
            "ipv4": {
                "address": "10.0.2.15", 
                "netmask": "255.255.255.0", 
                "network": "10.0.2.0"
            }, 
            "ipv6": [
                {
                    "address": "fe80::a00:27ff:fec9:399e", 
                    "prefix": "64", 
                    "scope": "link"
                }
            ], 
            "macaddress": "08:00:27:c9:39:9e", 
            "module": "e1000", 
            "mtu": 1500, 
            "type": "ether"
        }, 
        "ansible_eth1": {
            "active": true, 
            "device": "eth1", 
            "ipv4": {
                "address": "192.168.33.12", 
                "netmask": "255.255.255.0", 
                "network": "192.168.33.0"
            }, 
            "ipv6": [
                {
                    "address": "fe80::a00:27ff:fed5:dab6", 
                    "prefix": "64", 
                    "scope": "link"
                }
            ], 
            "macaddress": "08:00:27:d5:da:b6", 
            "module": "e1000", 
            "mtu": 1500, 
            "type": "ether"
        }, 
        "ansible_form_factor": "Other", 
        "ansible_fqdn": "localhost.localdomain", 
        "ansible_hostname": "localhost", 
        "ansible_interfaces": [
            "lo", 
            "eth1", 
            "eth0"
        ], 
        "ansible_kernel": "2.6.32-358.el6.x86_64", 
        "ansible_lo": {
            "active": true, 
            "device": "lo", 
            "ipv4": {
                "address": "127.0.0.1", 
                "netmask": "255.0.0.0", 
                "network": "127.0.0.0"
            }, 
            "ipv6": [
                {
                    "address": "::1", 
                    "prefix": "128", 
                    "scope": "host"
                }
            ], 
            "mtu": 16436, 
            "type": "loopback"
        }, 
        "ansible_machine": "x86_64", 
        "ansible_memfree_mb": 323, 
        "ansible_memtotal_mb": 458, 
        "ansible_mounts": [
            {
                "device": "/dev/mapper/VolGroup-lv_root", 
                "fstype": "ext4", 
                "mount": "/", 
                "options": "rw", 
                "size_available": 497491697664, 
                "size_total": 525282689024
            }, 
            {
                "device": "/dev/sda1", 
                "fstype": "ext4", 
                "mount": "/boot", 
                "options": "rw", 
                "size_available": 448802816, 
                "size_total": 507744256
            }, 
            {
                "device": "/vagrant", 
                "fstype": "vboxsf", 
                "mount": "/vagrant", 
                "options": "uid=501,gid=501,rw", 
                "size_available": 72607436800, 
                "size_total": 117461032960
            }
        ], 
        "ansible_os_family": "RedHat", 
        "ansible_pkg_mgr": "yum", 
        "ansible_processor": [
            "Intel(R) Core(TM) i3-3217U CPU @ 1.80GHz"
        ], 
        "ansible_processor_cores": "NA", 
        "ansible_processor_count": 1, 
        "ansible_product_name": "VirtualBox", 
        "ansible_product_serial": "NA", 
        "ansible_product_uuid": "NA", 
        "ansible_product_version": "1.2", 
        "ansible_python_version": "2.6.6", 
        "ansible_selinux": false, 
        "ansible_ssh_host_key_dsa_public": "...", 
        "ansible_ssh_host_key_rsa_public": "...", 
        "ansible_swapfree_mb": 2559, 
        "ansible_swaptotal_mb": 2559, 
        "ansible_system": "Linux", 
        "ansible_system_vendor": "innotek GmbH", 
        "ansible_user_id": "vagrant", 
        "ansible_userspace_architecture": "x86_64", 
        "ansible_userspace_bits": "64", 
        "ansible_virtualization_role": "guest", 
        "ansible_virtualization_type": "virtualbox", 
        "facter_architecture": "x86_64", 
        "facter_augeasversion": "0.9.0", 
        "facter_blockdevice_sda_model": "VBOX HARDDISK", 
        "facter_blockdevice_sda_size": 536870912000, 
        "facter_blockdevice_sda_vendor": "ATA", 
        "facter_blockdevice_sr0_model": "CD-ROM", 
        "facter_blockdevice_sr0_size": 1073741312, 
        "facter_blockdevice_sr0_vendor": "VBOX", 
        "facter_blockdevice_sr1_model": "CD-ROM", 
        "facter_blockdevice_sr1_size": 1073741312, 
        "facter_blockdevice_sr1_vendor": "VBOX", 
        "facter_blockdevices": "sda,sr0,sr1", 
        "facter_facterversion": "1.7.0", 
        "facter_filesystems": "ext4,iso9660", 
        "facter_hardwareisa": "x86_64", 
        "facter_hardwaremodel": "x86_64", 
        "facter_hostname": "localhost", 
        "facter_id": "vagrant", 
        "facter_interfaces": "eth0,eth1,lo", 
        "facter_ipaddress": "10.0.2.15", 
        "facter_ipaddress_eth0": "10.0.2.15", 
        "facter_ipaddress_eth1": "192.168.33.12", 
        "facter_ipaddress_lo": "127.0.0.1", 
        "facter_is_virtual": "true", 
        "facter_kernel": "Linux", 
        "facter_kernelmajversion": "2.6", 
        "facter_kernelrelease": "2.6.32-358.el6.x86_64", 
        "facter_kernelversion": "2.6.32", 
        "facter_macaddress": "08:00:27:C9:39:9E", 
        "facter_macaddress_eth0": "08:00:27:C9:39:9E", 
        "facter_macaddress_eth1": "08:00:27:D5:DA:B6", 
        "facter_memoryfree": "366.08 MB", 
        "facter_memoryfree_mb": "366.08", 
        "facter_memorysize": "458.64 MB", 
        "facter_memorysize_mb": "458.64", 
        "facter_memorytotal": "458.64 MB", 
        "facter_mtu_eth0": "1500", 
        "facter_mtu_eth1": "1500", 
        "facter_mtu_lo": "16436", 
        "facter_netmask": "255.255.255.0", 
        "facter_netmask_eth0": "255.255.255.0", 
        "facter_netmask_eth1": "255.255.255.0", 
        "facter_netmask_lo": "255.0.0.0", 
        "facter_network_eth0": "10.0.2.0", 
        "facter_network_eth1": "192.168.33.0", 
        "facter_network_lo": "127.0.0.0", 
        "facter_operatingsystem": "CentOS", 
        "facter_operatingsystemmajrelease": "6", 
        "facter_operatingsystemrelease": "6.4", 
        "facter_osfamily": "RedHat", 
        "facter_path": "/usr/local/bin:/bin:/usr/bin", 
        "facter_physicalprocessorcount": 1, 
        "facter_processor0": "Intel(R) Core(TM) i3-3217U CPU @ 1.80GHz", 
        "facter_processorcount": "1", 
        "facter_ps": "ps -ef", 
        "facter_puppetversion": "3.1.1", 
        "facter_rubysitedir": "/usr/lib/ruby/site_ruby/1.8", 
        "facter_rubyversion": "1.8.7", 
        "facter_selinux": "false", 
        "facter_sshdsakey": "...", 
        "facter_sshfp_dsa": "SSHFP 2 1 ...\nSSHFP 2 2 ...", 
        "facter_sshfp_rsa": "SSHFP 1 1 ...\nSSHFP 1 2 ...", 
        "facter_sshrsakey": "...", 
        "facter_swapfree": "2.50 GB", 
        "facter_swapfree_mb": "2559.99", 
        "facter_swapsize": "2.50 GB", 
        "facter_swapsize_mb": "2559.99", 
        "facter_timezone": "UTC", 
        "facter_uniqueid": "007f0100", 
        "facter_uptime": "1:09 hours", 
        "facter_uptime_days": 0, 
        "facter_uptime_hours": 1, 
        "facter_uptime_seconds": 4195, 
        "facter_virtual": "virtualbox"
    }, 
    "changed": false
}
</pre></code>
このようにして収集したデータを task のオプションやテンプレートの変数に使うことができます。
<ul>
  <li>IP Address は <code>{{ansible_eth0.ipv4.address}}</code> のようにして使えます
<pre><code>tasks:
  - name: gathering data task example
    command: echo {{ansible_eth0.ipv4.address}}
</code></pre>
  </li>
  <li><code>{{ansible_processor_count * 5}}</code> と計算結果を使うこともできます。CPUのコア数を元にプロセス数を設定したりする場合に使えます。</li>
  <li>次のようにして task 実行の条件判定にも使えます
<pre><code>tasks:
  - name: "shutdown Debian flavored systems"
    command: /sbin/shutdown -t now
    when: ansible_os_family == "Debian"
</code></pre>
  </li>
</ul>
そして、これらのデータが不要な場合は <code>gather_facts: no</code> とすることで収集しないことで playbook の実行時間を短縮できます。
<pre><code>- hosts: all
  sudo: yes
  gather_facts: no
  roles:
    - common
</code></pre>
</p>

<h3>
<a name="best-practices" class="anchor" href="#best-practices"><span class="octicon octicon-link"></span></a>7. Best Plactices に沿った構成を真似る</h3>
<p>
<a href="http://www.ansibleworks.com/docs/bestpractices.html">Best Practices</a> のディレクトリ構成にならって WordPress サーバーを構築する Playbook を作成します。
ここは長くなりそうだから詳細は別ページにしよう。<br>
<br>
こんなディレクトリ構成で進めます。<a href="https://github.com/yteraoka/ansible-tutorial/tree/playbook">playbook branch</a> のファイルで一応動作すると思います。随時改善していきます。

このファイルは <a href="https://github.com/yteraoka/ansible-tutorial/archive/playbook.zip">https://github.com/yteraoka/ansible-tutorial/archive/playbook.zip</a> からダウンロードできます。

<pre><code>$ <span class="console-input">tree</span>
.
├── common.yml
├── group_vars
├── host_vars
├── roles
│   ├── common
│   │   ├── files
│   │   ├── handlers
│   │   │   └── main.yml
│   │   ├── tasks
│   │   │   ├── common-packages.yml
│   │   │   ├── epel.yml
│   │   │   ├── main.yml
│   │   │   ├── ntp.yml
│   │   │   └── sshd.yml
│   │   ├── templates
│   │   └── vars
│   └── wordpress
│       ├── files
│       │   └── wordpress-3.5.2-ja.zip
│       ├── handlers
│       │   └── main.yml
│       ├── tasks
│       │   ├── httpd.yml
│       │   ├── main.yml
│       │   ├── mysql.yml
│       │   ├── php.yml
│       │   └── wordpress.yml
│       ├── templates
│       │   ├── httpd.conf.j2
│       │   └── wp-config.php.j2
│       └── vars
│           └── main.yml
├── site.yml
├── test-servers
└── wordpress.yml

15 directories, 20 files
</code></pre>

タスクの一覧を確認するには次のように <code>--list-tasks</code> オプションをつけて <code>ansible-playboook</code> コマンドを実行します。
<pre><code>$ <span class="console-input">ansible-playbook --list-tasks site.yml</span>

playbook: site.yml

  play #1 (all): task count=7
    be sure epel repository is installed
    be sure common packages are installed
    configure sshd_config
    be sure ntpd is running and enabled

Please enter MySQL wordpress user password: 
  play #2 (wordpress): task count=19
    be sure httpd is installed
    create document root
    be sure httpd is configured
    remove httpd welcome.conf
    be sure httpd is running and enabled
    be sure mysql-server is installed
    be sure mysqldb is installed
    be sure mysqld is running and enabled
    Create database
    Create database user
    be sure php is installed
    be sure php-mysql is installed
    disable password authentication
    copy wordpress zip file
    unzip wordpress zip file
    configure wp-config.php

</code></pre>
(随時更新しているため↑この内容は現在の repository のものとはずれてる場合があります)
<br>
実際の実行は次のコマンドになります。
<pre><code>$ <span class="console-input">ansible-playbook -i test-servers site.yml</span>
</code></pre>

<h3>
<a name="best-practices-directory" class="anchor" href="#best-practices-directory"><span class="octicon octicon-link"></span></a>7.1. 各ディレクトリ、ファイルの役割・意味</h3>
<p>

数種類のサービスが Web - App - DB 構成(それぞれは Role)で構築されており、それぞれに2ヶ所のロケーションにあるとする(Multi-AZみたいな)

<dl>
  <dt>group_vars/</dt>
  <dd>グループ毎の変数を定義するのに使います、role ではありません、role 毎の変数は roles/{role_name}/vars/ を使います。例えばロケーション毎に異なる変数など。ファイル名は<a href="ansible-in-detail.html#inventory-file">インベントリファイル</a>で設定するグループ名です。インベントリファイルにグループ変数を書くことも可能です。</dd>
  <dt>host_vars/</dt>
  <dd>ホスト毎の変数を定義するのに使います。group_vars と同じくファイル名は<a href="ansible-in-detail.html#inventory-file">インベントリファイル</a>に設定したホスト名です。インベントリファイルの中でホスト名の右に並べて書くこともできます。</dd>
  <dt>roles/</dt>
  <dd>このディレクトリの下に role (役割) 毎のディレクトリを作成し、それぞれの role にさらに <code>files/</code>, <code>handlers/</code>, <code>tasks/</code>, <code>templates/</code>, <code>vars/</code> というサブディレクトリを作成します。 </dd>
  <dt>roles/*/files/</dt>
  <dd>当該 role の task で使うファイル関連モジュール (<a href="http://www.ansibleworks.com/docs/modules.html#file">file</a>, <a href="http://www.ansibleworks.com/docs/modules.html#copy">copy</a>) が src として使うファイルの置き場所。任意のファイル名で置きます。</dd>
  <dt>roles/*/handlers/</dt>
  <dd>設定変更後にサービスの再起動をさせたりする場合に、notify という定義で処理を呼び出しますが、その呼び出されるハンドラをここで定義します。main.yml というファイルで作成しますが、<code>include</code> という定義で複数ファイルをそこから読み込ませることが可能です。</dd>
  <dt>roles/*/tasks/</dt>
  <dd>何かをインストールしたり、ユーザーを作成したりする task 定義のファイルをここに置きます。handlers と同じように mail.yml というファイルが起点となります。</dd>
  <dt>roles/*/templates/</dt>
  <dd><a href="http://www.ansibleworks.com/docs/modules.html#template">template</a> モジュールで利用するテンプレートファイルを置きます。このモジュールでは <a href="http://jinja.pocoo.org/docs/">Jinja2</a> (神社) というテンプレートエンジンが使われていて <code>.j2</code> とうい拡張子を使います。</dd>
  <dt>roles/*/vars/</dt>
  <dd>role 毎に設定する変数を定義するファイルを置きます。handlers や tasks と同じく main.yml ファイルが起点となります。</dd>
  <dt>sites.yml</dt>
  <dd><code>ansible-playbook</code> コマンドに渡す大元 (root) の playbook ファイルです。</dd>
  <dt>test-servers</dt>
  <dd>今回のインベントリファイルです。実際の運用では development, stage, production などというそれぞれの環境毎のファイルにするのが Best Practice っぽいです。</dd>
  <dt>wordpress.yml</dt>
  <dd>role 毎の対象グループ、対象ホストなどを定義します。今回は wordpress サーバーをセットアップする wordpress role とするため、このファイル名としてあります。site.yml で include されています。</dd>
</dl>
</p>

<h3>
<a name="list-variable" class="anchor" href="#list-variable"><span class="octicon octicon-link"></span></a>7.2. リスト変数を使った処理</h3>
<p>
<code>roles/common/tasks/common-packages.yml</code> を見てみましょう。
<pre><code>- name: be sure common packages are installed
  yum: name={{item}} state=installed
  with_items:
    - ntp
    - bind-utils
    - unzip
  tags: common-packages
</code></pre>
<code>with_items</code> にインストールされているべきパッケージ名を並べ、それぞれを <a href="ansible-in-detail.html#module-yum">yum モジュール</a>で処理します。
<code>tags</code> を指定しておくと ansible-playbook の <code>--tags</code> オプションを使うことで指定の tag のついた task だけを実行可能。複数の task に同じ tag を付けられます。<br>

<br>

<code>roles/common/tasks/sshd.yml</code> でも sshd_config の複数行の編集をまとめるために <code>with_items</code> を使っています。
<pre><code>- name: configure sshd_config
  lineinfile: dest=/etc/ssh/sshd_config owner=root group=root mode=0600 backup=yes {{item}}
  with_items:
    - regexp='^PasswordAuthentication' line='PasswordAuthentication no' insertafter='PasswordAuthentication no'
    - regexp='^PermitRootLogin' line='PermitRootLogin no' insertafter='#PermitRootLogin'
    - regexp='^GSSAPIAuthentication' line='GSSAPIAuthentication no' insertafter='#GSSAPIAuthentication'
  notify: restart sshd
  tags: sshd
</code></pre>
それぞれ別の task にしてしまうと <code>notify</code> によて3度も sshd の restart が必要になってしまう...と思ったら、別々にしても <code>notify</code> は一度しか処理されませんでした。よって、こういう場合はわかりやすい書き方を選ぶのが良いでしょう。<br>
<br>
<a href="ansible-in-detail.html#module-lineinfile"><code>lineinfile</code></a> モジュールは設定ファイルの置換に便利です。<code>insertafter</code> や <code>backref</code> オプションは要<a href="ansible-in-detail.html#module-lineinfile">チェック</a>です。
</p>

<h3>
<a name="mysql" class="anchor" href="#mysql"><span class="octicon octicon-link"></span></a>7.3. MySQL 関連</h3>
<p>
パッケージのインストールだけでなく、DBの作成、ユーザーの作成も行えます。
<pre><code># yum で mysql-server パッケージをインストール
- name: be sure mysql-server is installed
  yum: pkg=mysql-server state=installed
  tags: mysqld

# mysql_user で必要な python モジュールをインストールする
- name: be sure mysqldb is installed
  yum: pkg=MySQL-python state=installed
  tags: mysqld

# mysqld の起動、自動起動設定
- name: be sure mysqld is running and enabled
  service: name=mysqld state=running enabled=yes
  tags: mysqld

# wordpress 用 DB の作成
- name: Create database
  action: mysql_db db={{dbname}} state=present
  tags: mysqld

# wordpress 用 DB ユーザーの作成
- name: Create database user
  action: mysql_user name=${dbuser} password=${dbpassword} priv=${dbname}.*:ALL state=present
  tags: mysqld
</code></pre>

<code>dbname</code>, <code>dbuser</code> 変数は <code>roles/wordpress/vars/main.yml</code> に書いてあり、<code>dbpassword</code> は <code>wordpress.yml</code> にて次のように <code>vas_prompt</code> 設定し、ansible-playbook 実行時に入力させている。
<code><pre>- hosts: wordpress
  sudo: yes
  roles:
    - wordpress
  vars_prompt:
    - name: "dbpassword"
      prompt: "Please enter MySQL wordpress user password"
      default: "wordpress"
</code></pre>
</p>

<h3>
<a name="test-with-serverspec" class="anchor" href="#test-with-serverspec"><span class="octicon octicon-link"></span></a>8. serverspec でテストする</h3>
<p>
</p>

<h3><a name="install-ruby" class="anchor" href="#install-ruby"><span class="octicon octicon-link"></span></a>8.1. Ruby のインストール</h3>
<p>
CentOS 6 はいまだに 1.8.7 だから最新のバージョンを /opt/ruby-2.0.0 にインストール<br>
<br>
まずは Ruby のコンパイルに必要なものをインストール
<pre><code>$ <span class="console-input">sudo yum -y install git gcc gcc-c++ make patch readline-devel zlib-devel libyaml-devel</span></code></pre>

ruby-build を git clone する
<pre><code>$ <span class="console-input">git clone -q git://github.com/sstephenson/ruby-build.git</span></code></pre>

2.0.0-p247 をインストール
<pre><code>$ <span class="console-input">cd ruby-build</span>
$ <span class="console-input">sudo bin/ruby-build 2.0.0-p247 /opt/ruby-2.0.0</span></code></pre>
Tea Time...<br>
Ruby や Perl のコンパイルには結構時間がかかりますねぇ。
</p>

<h3><a name="install-serverspec" class="anchor" href="#install-serverspec"><span class="octicon octicon-link"></span></a>8.2. ServerSpec のインストール</h3>
<pre><code>$ <span class="console-input">sudo /opt/ruby-2.0.0/bin/gem install serverspec</span></code></pre>
あ、bundler 使ったほうが良かったかな？


<h3><a name="execute-serverspec" class="anchor" href="#execute-serverspec"><span class="octicon octicon-link"></span></a>8.3. ServerSpec を実行してみる</h3>

まずは <code>serverspec-init</code> コマンドで土台を作ります。

<pre><code>$ <span class="console-input">/opt/ruby-2.0.0/bin/serverspec-init</span>
Select a backend type:

  1) SSH
  2) Exec (local)

Select number: 1

Vagrant instance y/n: n
Input target host name: 192.168.33.12
 + spec/
 + spec/192.168.33.12/
 + spec/192.168.33.12/httpd_spec.rb
 + spec/spec_helper.rb
 + Rakefile
</code></pre>
Vagrant 使ってるけど、Vagrant の Guest 同士での SSH だから Vagrant じゃないよと。<br>
今回の設定では httpd.conf の ServerName は localhost となっているのでテストをちょっといじる
<pre><code>$ <span class="console-input">sed -i 's/192.168.33.12/localhost/' spec/192.168.33.12/httpd_spec.rb</span></code></pre>

それでは rake コマンドでテストを実行してみましょう

<pre><code>$ <span class="console-input">/opt/ruby-2.0.0/bin/rake spec</span>
/opt/ruby-2.0.0/bin/ruby -S rspec spec/192.168.33.12/httpd_spec.rb
/opt/ruby-2.0.0/bin/ruby: No such file or directory -- rspec (LoadError)
rake aborted!
/opt/ruby-2.0.0/bin/ruby -S rspec spec/192.168.33.12/httpd_spec.rb failed

Tasks: TOP =&gt; spec
(See full trace by running task with --trace)
</code></pre>

あらら、失敗。PATH の問題っぽい。
<pre><code>$ <span class="console-input">PATH=/opt/ruby-2.0.0/bin:$PATH</span>
$ <span class="console-input">/opt/ruby-2.0.0/bin/rake spec</span>
/opt/ruby-2.0.0/bin/ruby -S rspec spec/192.168.33.12/httpd_spec.rb
......

Finished in 0.62573 seconds
6 examples, 0 failures</code></pre>
成功しました。<br>
<code>spec/192.168.33.12/httpd_spec.rb</code> に書いてあるテストが実行されました。<br>
内容は次の通り
<ul>
  <li>httpd パッケージがインストールされていること</li>
  <li>httpd サービスが有効になっていること (<code>chkconfig httpd on</code> 状態)</li>
  <li>httpd が起動していること</li>
  <li>ポート 80 が LISTEN 状態となっていること</li>
  <li><code>/etc/httpd/conf/httpd.conf</code> ファイルが存在すること</li>
  <li>httpd.conf に "ServerName localhost" が含まれること</li>
</ul>
</p>

<h3><a name="test-mysqld" class="anchor" href="#test-mysqld"><span class="octicon octicon-link"></span></a>8.4. mysqld のテストを作成</h3>
<p>
<code>httpd_spec.rb</code> を参考に mysqld のテストを作成しましょう。<br>
これは JTF <del>のパクリですね</del> とまったく同じ課題ですね。
<ul>
  <li>mysql-server パッケージがインストールされていること</li> 
  <li>mysqld デーモンが有効化されていること (chkconfig mysqld on されていること)</li> 
  <li>mysqld デーモンが起動していること</li> 
  <li>3306 ポートが LISTEN していること</li> 
</ul>

<pre><code>$ vi spec/192.168.33.12/mysqld_spec.rb</code></pre>

(例はこちら: <a href="https://gist.github.com/yteraoka/6156753">https://gist.github.com/yteraoka/6156753</a>)
</p>

<h3><a name="test-wordpress" class="anchor" href="#test-wordpress"><span class="octicon octicon-link"></span></a>8.5. WordPress のテストを作成</h3>
<p>
Chef 版との違いが出ましたよ。WordPress が日本語版だったので出力されるHTMLが日本語です。
http://localhost/wp-admin/install.php にアクセスすると出力されるメッセージ(HTML)に「<strong>5分でできる WordPress の有名なインストールプロセスへようこそ</strong>」が含まれることをチェックしましょう。<br>
<br>
<del>あぁぁ、ServerSpec の command 出力を日本語でマッチさせる方法がわからん...<br>
誰か教えてくださいまし。</del>ただ、日本語文字列のコピペをミスっていただけでした...
<pre><code>$ vi spec/192.168.33.12/wordpress_spec.rb</code></pre>

(例はこちら: <a href="https://gist.github.com/yteraoka/6186278">https://gist.github.com/yteraoka/6186278</a>)
</p>


<h3><a name="more" class="anchor" href="#more"><span class="octicon octicon-link"></span></a>9. もっと知る</h3>
<p>
<a href="ansible-in-detail.html">ansible-in-detail.html</a> にモジュールの説明や細かいことを書いています。
</p>

        </section>

        <footer>
          Ansible Tutorial is maintained by <a href="https://github.com/yteraoka">yteraoka</a>
        </footer>

        
      </div>
    </div>
  </body>
</html>
