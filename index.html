<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Ansible Tutorial</title>
    <style type="text/css">
pre code {
  font-family: courier new;
  font-size: 9pt;
}
span.console-yellow {
  color: #C4A000;
}
span.console-green {
  color: #4E9A06;
}
span.console-blue {
  color: #3465A4;
}
span.console-input {
  font-weight: bold;
  font-size: 10pt;
}
dd {
  margin-left: 2em;
  margin-bottom: 0.5em;
}
    </style>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721713-1', 'yteraoka.github.io');
  ga('send', 'pageview');

</script>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Ansible Tutorial</h1>
          <h2>あんしぼー ちゅーとりある</h2>
        </header>

<!--
        <section id="downloads" class="clearfix">
          <a href="https://github.com/yteraoka/test/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/yteraoka/test/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/yteraoka/test" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>
-->

        <hr>

        <section id="main_content">

          <h3><a name="overview" class="anchor" href="#overview"><span class="octicon octicon-link"></span></a>概要</h3>

<p><a href="http://www.techfesta.jp/">July Tech Festa</a> にて開催されたハンズオンの<a href="http://tily.github.io/jtf2013/">資料が公開</a>されていたことに刺激され、Chef の代わりに Ansible を使う資料を作り<del>ました</del>始めました。
Ansible を使って WordPress サーバーのセットアップを行います。<br>
まだ Ansible を試し始めたばかりで自分の勉強がてら書いています。<br>
Puppet にも Chef にも乗り遅れたので Ansible に飛び乗ってみようかと。
</p>
<p>
※鋭意作成中です。<br>
<a href="https://github.com/yteraoka/ansible-tutorial/">https://github.com/yteraoka/ansible-tutorial/</a> コメントなどお待ちしております。
</p>

<h3><a name="table-of-contents" class="anchor" href="#table-of-contents"><span class="octicon octicon-link"></span></a>目次</h3>

<p>
<ol>
  <li><a href="#server-setup-using-vagrant">Vagrant を使ってサーバーを準備する</a></li>
  <li><a href="#install-ansible">Ansible のインストール</a></li>
  <li><a href="#prepare-ansible">Ansible を使うための準備</a></li>
  <li><a href="#test-ansible">Ansible の疎通確認</a></li>
  <li><a href="#simple-playbook">簡単な Playbook を書いて試す</a></li>
  <li><a href="#best-practices">Best Plactices に沿った構成を真似る</a> (途中)</li>
  <li><a href="#test-with-serverspec">serverspec でテストする</a> (まだなにも)</li>
  <li><a href="ansible-in-detail.html">もっと知る</a></li>
</ol>
</p>

<h3><a name="server-setup-using-vagrant" class="anchor" href="#server-setup-using-vagrant"><span class="octicon octicon-link"></span></a>1. Vagrant を使ってサーバーを準備する</h3>
<p>
何度でも綺麗な環境でやり直せるように VirtualBox + Vagrant を使ってこの Tutorial 用環境を構築します。

<ul>
  <li><a href="http://blog.1q77.com/2013/03/vagrant-1/">Vagrant メモ(1)</a></li>
  <li><a href="http://blog.1q77.com/2013/03/vagrant-2/">Vagrant メモ(2)</a></li>
</ul>

あたりを参考に最新版の VirtualBox と Vagrant をインストールしてください。
Sahara plugin なんかを使うとやり直しも簡単ですが、再構築してもそんなに時間かからないのでお好みで。

<pre><code>$ <span class="console-input">mkdir ansible-tutorial</span>
$ <span class="console-input">cd ansible-tutorial</span>
$ <span class="console-input">vagrant init centos6 http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20130427.box</span>
</code></pre>

Ansible サーバーと、Ansible に制御される側の2台のサーバーを立てることにするので <code>Vagrantfile</code> を編集します。

<pre><code>$ <span class="console-input">vi Vagrantfile</span></code></pre>

<code>config.vm.box = "centos6"</code> の行を次のように書き換えます。2台じゃなくて3台でも4台でもOK

<pre>
  config.vm.define :node1 do |node|
    node.vm.box = "centos6"
    node.vm.network :forwarded_port, guest: 22, host: 2001, id: "ssh"
    node.vm.network :private_network, ip: "192.168.33.11"
  end

  config.vm.define :node2 do |node|
    node.vm.box = "centos6"
    node.vm.network :forwarded_port, guest: 22, host: 2002, id: "ssh"
    node.vm.network :forwarded_port, guest: 80, host: 8000, id: "http"
    node.vm.network :private_network, ip: "192.168.33.12"
  end
</pre>

編集が終わったら起動させます。
<pre><code>$ <span class="console-input">vagrant up</span></code></pre>

起動後、Ansible で node1 から node2 へ ssh するため、Vagrant 用の秘密鍵をコピーする。
<pre><code>$ <span class="console-input">vagrant ssh-config node1 &gt; ssh_config</span>
$ <span class="console-input">vagrant ssh-config node2 &gt;&gt; ssh_config</span>
$ <span class="console-input">scp -F ssh_config ~/.vagrant.d/insecure_private_key node1:.ssh/id_rsa</span>
</code></pre>

<code>vagrant ssh</code> コマンドでログインできます
<pre><code>$ <span class="console-input">vagrant ssh node1</span>
$ <span class="console-input">vagrant ssh node2</span>
</code></pre>

やり直したくなったら destroy して up すれば元の状態に戻ります
<pre><code>$ <span class="console-input">vagrant destroy node2</span>
$ <span class="console-input">vagrant up node2</span>
</code></pre>
</p>

<h3><a name="install-ansible" class="anchor" href="#install-ansible"><span class="octicon octicon-link"></span></a>2. Ansible をインストールする</h3>

<p>
node1 に Ansible をインストールします。CentOS 6 なので EPEL リポジトリから yum でインストールします。

<pre><code>$ <span class="console-input">sudo rpm -ivh http://ftp-srv2.kddilabs.jp/Linux/distributions/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
$ <span class="console-input">sudo rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</span>
$ <span class="console-input">sudo yum -y install ansible</span>
</code></pre>

楽ちんですね。

</p>


<h3>
<a name="prepare-ansible" class="anchor" href="#prepare-ansible"><span class="octicon octicon-link"></span></a>3. Ansible を使うための準備</h3>

<p>
vagrant ssh を使うと vagrant ユーザーでログインし、パスワードなしで sudo で root としてコマンドが実行可能なので、Ansible の実行も vagrant ユーザーで行う。
</p>

<h3>
<a name="test-ansible" class="anchor" href="#test-ansible"><span class="octicon octicon-link"></span></a>4. Ansible の疎通確認</h3>

<p>
<pre><code>$ <span class="console-input">ansible 192.168.33.12 -m ping</span>
<span class="console-green">192.168.33.12 | success &gt;&gt; {
    "changed": false, 
    "ping": "pong"
}</span></code></pre>

<code>ansible-doc</code> コマンドでモジュールのドキュメントを読むことができます。
<pre><code>$ <span class="console-input">ansible-doc ping</span>
&gt; PING

  A trivial test module, this module always returns `pong' on
  successful contact. It does not make sense in playbooks, but it is
  useful from `/usr/bin/ansible'

Example:

ansible webservers -m ping
</code></pre>

<pre><code>$ <span class="console-input">ansible 192.168.33.12 -a 'uname -r'</span>
<span class="console-green">192.168.33.12 | success | rc=0 &gt;&gt;
2.6.32-358.el6.x86_64</span></code></pre>
</p>

<h3>
<a name="simple-playbook" class="anchor" href="#simple-playbook"><span class="octicon octicon-link"></span></a>5. 簡単な Playbook を書いて試す</h3>

<p>
まずは<a href="ansible-in-detail.html#inventory-file">インベントリファイル</a>を作成する。yum でインストールした Ansible の場合、デフォルトのインベントリファイルは <code>/etc/ansible/hosts</code> となっている。これは <code>/etc/ansible/ansible.cfg</code> で定義されている。別のファイルを使う場合は <code>-i</code> オプションで指定する。
<pre><code>$ <span class="console-input">cat &lt;&lt;_EOD_ &gt; hosts</span>
[test-servers]
192.168.33.12
<span class="console-input">_EOD_</span>
</code></pre>
<pre><code>$ <span class="console-input">cat &lt;&lt;_EOD_ &gt; simple-playbook.yml</span>
- hosts: test-servers
  user: vagrant
  sudo: yes
  tasks:
    - name: be sure httpd is installed
      action: yum pkg=httpd state=installed

    - name: be sure httpd is running and enabled
      service: name=httpd state=running enabled=yes
<span class="console-input">_EOD_</span>
</code></pre>

この playbook の内容は
<dl>
  <dt><code>hosts: test</code></dt>
  <dd>対象のホストまたはグループを指定する</dd>
  <dt><code>user: vagrant</code></dt>
  <dd>リモートホストへ vagrant ユーザとして ssh でログインする</dd>
  <dt><code>sudo: yes</code></dt>
  <dd>リモートホストで sudo を使って処理を実行する</dd>
  <dt><code>tasks:</code></dt>
  <dd>実行する処理をリストで定義する</dd>
</dl>

<code>tasks</code> の内容
<dl>
  <dt><code>name:</code></dt>
  <dd>処理の名称実行時に表示されます</dd>
  <dt><code>action:</code></dt>
  <dd>これは省略可能で <code>yum:</code> とも書ける</dd>
  <dt><code>service:</code></dt>
  <dd>サービスの状態を制御するモジュール</dd>
</dl>

実行結果は次の様になる。

<pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml</span>

PLAY [test-servers] *********************************************************** 

GATHERING FACTS *************************************************************** 
<span class="console-green">ok: [192.168.33.12]</span>

TASK: [be sure httpd is installed] ******************************************** 
<span class="console-yellow">changed: [192.168.33.12]</span>

TASK: [be sure httpd is running and enabled] ********************************** 
<span class="console-yellow">changed: [192.168.33.12]</span>

PLAY RECAP ******************************************************************** 
<span class="console-yellow">192.168.33.12</span>              : <span class="console-green">ok=3</span>    <span class="console-yellow">changed=2</span>    unreachable=0    failed=0
</code></pre>

node2 で確認
<pre><code>$ <span class="console-input">sudo chkconfig --list httpd</span>
httpd          	0:off	1:off	2:on	3:on	4:on	5:on	6:off
$ <span class="console-input">sudo service httpd status</span>
httpd (pid  2424) is running...
</code></pre>

冪等性があるため再度実行しても対象サーバーの状態は変わらない。
ただし、既に package がインストールされていたり、サービスの設定がされていたりするのでコマンドの出力は変わる。(changed が ok だったり skipping だったりする)
<br>
<br>
2度目の実行の出力
<pre><code>$ <span class="console-input">ansible-playbook -i hosts simple-playbook.yml</span>

PLAY [test-servers] *********************************************************** 

GATHERING FACTS *************************************************************** 
<span class="console-green">ok: [192.168.33.12]</span>

TASK: [be sure httpd is installed] ******************************************** 
<span class="console-green">ok: [192.168.33.12]</span>

TASK: [be sure httpd is running and enabled] ********************************** 
<span class="console-green">ok: [192.168.33.12]</span>

PLAY RECAP ******************************************************************** 
<span class="console-green">192.168.33.12</span>              : <span class="console-green">ok=3</span>    changed=0    unreachable=0    failed=0
</code></pre>
</p>

<h3>
<a name="best-practices" class="anchor" href="#best-practices"><span class="octicon octicon-link"></span></a>6. Best Plactices に沿った構成を真似る</h3>
<p>
<a href="http://www.ansibleworks.com/docs/bestpractices.html">Best Practices</a> のディレクトリ構成にならって WordPress サーバーを構築する Playbook を作成します。
ここは長くなりそうだから詳細は別ページにしよう。<br>
<br>
こんなディレクトリ構成で進めます。<a href="https://github.com/yteraoka/ansible-tutorial/tree/playbook">playbook branch</a> のファイルで一応動作すると思います。随時改善していきます。
<pre><code>$ tree -F
.
|-- common.yml
|-- group_vars/
|-- host_vars/
|-- roles/
|   |-- common/
|   |   |-- files/
|   |   |-- handlers/
|   |   |   `-- main.yml
|   |   |-- tasks/
|   |   |   |-- common-packages.yml
|   |   |   |-- epel.yml
|   |   |   |-- main.yml
|   |   |   |-- ntp.yml
|   |   |   `-- sshd.yml
|   |   |-- templates/
|   |   `-- vars/
|   `-- wordpress/
|       |-- files/
|       |   |-- welcome.conf
|       |   `-- wordpress-3.5.2-ja.zip
|       |-- handlers/
|       |   `-- main.yml
|       |-- tasks/
|       |   |-- httpd.yml
|       |   |-- main.yml
|       |   |-- mysql.yml
|       |   |-- php.yml
|       |   |-- pip.yml
|       |   `-- wordpress.yml
|       |-- templates/
|       |   `-- httpd.conf.j2
|       `-- vars/
|           `-- main.yml
|-- site.yml
|-- test-servers
`-- wordpress.yml

15 directories, 21 files
</code></pre>

次のように実行します。
<pre><code>$ <span class="console-input">ansible-playbook -i test-servers site.yml</span>
</code></pre>

<ul>
  <li>各ディレクトリの意味</li>
  <li>それぞれのファイルの説明</li>
</ul>
などを追記していく。

</p>

<h3>
<a name="test-with-serverspec" class="anchor" href="#test-with-serverspec"><span class="octicon octicon-link"></span></a>7. serverspec でテストする</h3>
<p>
まだ先。でもここは JTF のと同じかな？
</p>
        </section>

        <footer>
          Ansible Tutorial is maintained by <a href="https://github.com/yteraoka">yteraoka</a>
        </footer>

        
      </div>
    </div>
  </body>
</html>
