<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Ansible Tutorial</title>
    <style type="text/css">
pre code {
  font-family: courier new;
  font-size: 9pt;
}
span.console-yellow {
  color: #C4A000;
}
span.console-green {
  color: #4E9A06;
}
span.console-blue {
  color: #3465A4;
}
span.console-input {
  font-weight: bold;
  font-size: 10pt;
}
dd {
  margin-left: 2em;
  margin-bottom: 0.5em;
}
span.doc-link {
  font-size: smaller;
}
li ul {
  margin-bottom: 0;
}
    </style>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42721713-1', 'yteraoka.github.io');
  ga('send', 'pageview');

</script>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Ansible in detail</h1>
          <h2>あんしぼー 詳細</h2>
        </header>

        <hr>

        <section id="main_content">

<h3><a name="table-of-contents" class="anchor" href="#table-of-contents"><span class="octicon octicon-link"></span></a>目次</h3>

<p>
<ul>
  <li><a href="#inventory-file">インベントリファイル</a>
    <ul>
      <li><a href="#inventory-file-grouping">グルーピング</a></li>
      <li><a href="#inventory-file-hostvars">サーバー変数</a></li>
    </ul>
  </li>
  <li><a href="#ssh-config">SSHまわりの設定</a></li>
  <li><a href="#ansible-playbook">ansible-playbook コマンド</a></li>
<!--
  <li><a href="#"></a></li>
-->
</ul>
※こちらも鋭意作成中です。
</p>

<h3><a name="inventory-file" class="anchor" href="#inventory-file"><span class="octicon octicon-link"></span></a>インベントリファイル</h3>
<p>
Ansible では制御対象のサーバーのリストをインベントリファイルに書く必要があり、EPEL Repository から yum でインストールした場合、このファイルは <code>/etc/ansible/hosts</code> を使うように <code>/etc/ansible/ansible.cfg</code> で定義してある。が、<code>ansible</code>, <code>ansible-playbook</code> コマンドでは <code>-i</code> オプションで任意のファイルを指定することができる。Best Practices のドキュメントには test, staging, production などによってインベントリファイルを使い分けるよう書いてあります。<br>
<br>
コマンドラインオプションの他に <code>ANSIBLE_HOSTS</code> という環境変数で指定することもできます。
<pre><code>$ <span class="console-input">export ANSIBLE_HOSTS=/path/to/inventory-file</span></code></pre>

<h4><a name="inventory-file-grouping" class="anchor" href="#inventory-file-grouping"><span class="octicon octicon-link"></span></a>グルーピング</h4>
インベントリファイルには対象ホストのホスト名もしくはIPアドレスを列挙します。
グルーピングすることができ、playbook の <code>hosts</code> 設定で対象を特定のグループに絞ったりできます。<br>
<br>
グルーピングの例
<span class="doc-link">(<a href="http://www.ansibleworks.com/docs/patterns.html#id2">Hosts and Groups</a>)</span>
<pre><code>[app-servers]
app01
app02
app03

[db-servers]
db01
db02
db03
</code></pre>

連番のサーバー名であれば次の様に書くこともできます。
<pre><code>[webservers]
www[01:50].example.com

[databases]
db-[a:f].example.com
</code></pre>


<code>&</code> や <code>!</code> などで複雑な指定も可能です。
<span class="doc-link">(<a href="http://www.ansibleworks.com/docs/patterns.html#id4">Selecting Targets</a>)</span>

<br>
<br>

<h4><a name="inventory-file-hostvars" class="anchor" href="#inventory-file-hostvars"><span class="octicon octicon-link"></span></a>ホスト変数</h4>
インベントリファイルではホスト名、IPアドレスの後ろにそのサーバー用の変数を任意に複数指定できます。
<pre><code>server1  listen_port=80 relay_server=relay1
server2 listen_port=81 relay_server=relay2</pre></code>

予約変数名<br>
次の SSH の項目で説明しますが、SSH 関連で予約されている変数名があります。
<dl>
  <dt>ansible_ssh_host</dt>
  <dd>あまり必要な場面がなさそうですが、イベントリのホスト名とSSH接続用のホスト名を分けたい場合に指定</dd>
  <dt>ansible_ssh_port</dt>
  <dd>SSHポートが他と違う場合に指定する</dd>
  <dt>ansible_ssh_user</dt>
  <dd>SSHのユーザー名が他と違う場合に指定する</dd>
  <dt>ansible_ssh_pass</dt>
  <dd>SSHでパスワード認証する際のパスワードを指定</dd>
  <dt>ansible_connection</dt>
  <dd>対象サーバーへの接続方法 (local, ssh, paramiko)、デフォルトは paramiko</dd>
  <dt>ansible_ssh_private_key_file</dt>
  <dd>SSHの秘密鍵が他と違う場合に指定</dd>
  <dt>ansible_syslog_facility</dt>
  <dd>対象サーバーで出力する syslog の facility</dd>
  <dt>ansible_python_interpreter</dt>
  <dd>対象サーバーでの Python の path を指定する。/usr/bin/python 以外を使いたい場合などに使う。/usr/bin/python が古い場合とか</dd>
  <dt>ansible_*_interpreter</dt>
  <dd>対象サーバーでの ruby とか perl の path を指定</dd>
</dl>

</p>

<h3><a name="ssh-config" class="anchor" href="#ssh-config"><span class="octicon octicon-link"></span></a>SSHまわりの設定</h3>
<p>
Ansible はデフォルトでは SSH 接続に Python の paramiko を使う(RHEL 6 の OpenSSH は古くて ControlPersist 機能がないため?)、このためか ~/.ssh/config を読んではくれない。標準の path の秘密鍵以外を使いたい場合や 22 番以外のポートを使いたい場合はインベントリファイルにホスト毎、グループ毎、全体の変数を設定する。
<br>
<pre><code>[group-a]
server1 ansible_ssh_port=2222
server2 ansible_ssh_user=bob

[group-b]
server3
server4

[group-b:vars]
ansible_ssh_port=3333

[all:vars]
ansible_ssh_port=1234
</code></pre>
<br>
秘密鍵だけはコマンドラインオプションで指定できる
<pre><code>$ <span class="console-input">ansible --private-key=/path/to/key_file</span></code></pre>
変数の強度は「host &gt; group &gt; all &gt; コマンドラインオプション」の順。
</p>

<h3><a name="ansible-playbook" class="anchor" href="#ansible-playbook"><span class="octicon octicon-link"></span></a>ansible-playbook コマンド</h3>
<p>
オプション
<dl>
  <dt><code>-k, --ask-pass</code></dt>
  <dd>SSH のパスワードを尋ねる(プロンプトが出る)</dd>
  <dt><code>-K, --ask-sudo-pass</code></dt>
  <dd>sudo のパスワードを尋ねる(プロンプトが出る)</dd>
  <dt><code>-C, --check</code></dt>
  <dd>インストールなどの変更は行わないが、条件の確認などは実行する</dd>
  <dt><code>-c CONNECTION, --connection=CONNECTION</code></dt>
  <dd>local, ssh, paramiko から選択。デフォルトは paramiko。古い OpenSSH で ssh を指定する場合は <code>ANSIBLE_SSH_ARGS=""</code> と環境変数を空で上書きする必要がある</dd>
  <dt><code>-D, --diff</code></dt>
  <dd>file や template の差分(diff)を表示する。<code>--check</code> と一緒に使うと便利</dd>
  <dt><code>-e EXTRA_VARS, --extra-vars=EXTRA_VARS</code></dt>
  <dd>追加の変数を key=value で指定する。playbook に書かれている変数の上書きはされない</dd>
  <dt><code>-f FORKS, --forks=FORKS</code></dt>
  <dd>並列実行する数(デフォルトは5)</dd>
  <dt><code>-h, --help</code></dt>
  <dd>このヘルプメッセージを表示して終了する</dd>
  <dt><code>-i INVENTORY, --inventory-file=INVENTORY</code></dt>
  <dd>インベントリファイルを指定する(デフォルトは /etc/ansible/hosts)</dd>
  <dt><code>-l SUBNET, --limit=SUBNET</code></dt>
  <dd>対象サーバーを指定のものだけに制限する</dd>
  <dt><code>--list-hosts</code></dt>
  <dd>それぞれの playbook の対象ホスト一覧を表示して終了する。playbook の実行はされない</dd>
  <dt><code>--list-tasks</code></dt>
  <dd>各 playbook のタスク一覧を表示して終了する</dd>
  <dt><code>-M MODULE_PATH, --module-path=MODULE_PATH</code></dt>
  <dd>モジュールファイルのディレクトリを指定する(デフォルトは /usr/share/ansible)</dd>
  <dt><code>--private-key=PRIVATE_KEY_FILE</code></dt>
  <dd>SSH の秘密鍵ファイルを指定する</dd>
  <dt><code>--start-at-task=START_AT</code></dt>
  <dd>指定の task から開始する</dd>
  <dt><code>--step</code></dt>
  <dd>ひとつの task ごとに "Perform task: タスク名 (y/n/c):" と確認される。y: (yes) 実行する、n: (no) 実行しない、c: (continue) 以降を確認なしで実行する</dd>
  <dt><code>-s, --sudo</code></dt>
  <dd>対象サーバーでの task を sudo で実行する</dd>
  <dt><code>-U SUDO_USER, --sudo-user=SUDO_USER</code></dt>
  <dd>sudo での実行ユーザーを指定する(デフォルトは root)</dd>
  <dt><code>--syntax-check</code></dt>
  <dd>playbook の文法チェックだけを行う</dd>
  <dt><code>-t TAGS, --tags=TAGS</code></dt>
  <dd>指定の tag が付けられた task のみを実行する</dd>
  <dt><code>-T TIMEOUT, --timeout=TIMEOUT</code></dt>
  <dd>SSH のタイムアウトを指定する(デフォルトは10秒)</dd>
  <dt><code>-u REMOTE_USER, --user=REMOTE_USER</code></dt>
  <dd>SSH で接続するユーザー名を指定する</dd>
  <dt><code>-v, --verbose</code></dt>
  <dd>冗長モード (-vvv でより冗長な出力になる)</dd>
  <dt><code>--version</code></dt>
  <dd>バージョンを表示して終了する</dd>
</dl>
</p>

<!--
<h3><a name="inventory-file" class="anchor" href="#inventory-file"><span class="octicon octicon-link"></span></a>インベントリファイル</h3>
<p>
</p>
-->

        </section>

        <footer>
          Ansible Tutorial is maintained by <a href="https://github.com/yteraoka">yteraoka</a>
        </footer>

        
      </div>
    </div>
  </body>
</html>
